<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>File Manager</title>
    <link rel="stylesheet" href="../static/css/bootstrap.min.css">
    <link rel="stylesheet" href="../static/css/navlist.css">
    <script src="../static/js/jquery-1.8.0.min.js"></script>
    <script src="../static/js/bootstrap.min.js"></script>
    <script>	
      $(document).ready(function(){
        if ("WebSocket" in window) {
          ws = new WebSocket("ws://" + document.domain + ":5000/ws");		  
          ws.onmessage = function (msg) {
            var message = JSON.parse(msg.data);
            var name = message.result.name;
            if (message.result.result == "deleteUserData succeed")
              $("tr#"+name).remove();
			else if(message.request=='getLoginedUserName')
			{
				sessionStorage.loginedUserName=message.result;
			}
			else if(message.request == "setFileShared")
			{				
				$('#mymodal').find('p').text(message.result);
				$('#mymodal').css('display','block');	
				//location.reload(); 									
			}else if(message.request=="unsharedAFile")
			{
				location.reload(); 
			}else if(message.request=='isExtractCodeRight'){
				console.log(message.result);
				if(message.result==false){
					alert('Wrong extract code!');
					return;
				}else{
					filetype=sessionStorage.filetype;
					filename=sessionStorage.filename;
					switch (filetype){
						case 'regulation':
							window.location = "index?"+'filetype='+filetype+'&filename='+filename;
							break;
						case 'simulation':
							window.location = "simulation?"+'filetype='+filetype+'&filename='+filename;
							break;
						case 'genecircuit':
							window.location = "genecircuit?"+'filetype='+filetype+'&filename='+filename;
							break;
						case 'plasmid':
							window.location = "plasmid?"+'filetype='+filetype+'&filename='+filename;
							break;
						case 'protocol':
							window.location = "protocol?"+'filetype='+filetype+'&filename='+filename;
							break;
					  }
				}
			}
          };
        };		
        // Bind send button to websocket
        $("button.delete").live("click", function() {
          filename = this.getAttribute("id");		  
          ws.send(JSON.stringify({'request': 'deleteUserData', 'name': filename}));
        });
		$("button.shared").live("click", function() {
			filename = this.getAttribute("id");
		    filetype = $(this).find("p").text();	
			ws.send(JSON.stringify({'request': 'setFileShared', 'filename': filename,'filetype':filetype}));			
		});
		$("button.unshared").live("click", function() {
			filename = this.getAttribute("id");
		    filetype = $(this).find("p").text();	
			ws.send(JSON.stringify({'request': 'unsharedAFile', 'filename': filename,'filetype':filetype}));
		});
		$("button.open").live("click", function() {
		  filename = this.getAttribute("id");
		  filetype = $(this).find("p").text();
		  switch (filetype){
			case 'regulation':
				window.location = "index?"+'filetype='+filetype+'&filename='+filename;
			  	break;
			case 'simulation':
			  	window.location = "simulation?"+'filetype='+filetype+'&filename='+filename;
			  	break;
			case 'genecircuit':
			  	window.location = "genecircuit?"+'filetype='+filetype+'&filename='+filename;
			  	break;
			case 'plasmid':
			  	window.location = "plasmid?"+'filetype='+filetype+'&filename='+filename;
			  	break;
			case 'protocol':
			  	window.location = "protocol?"+'filetype='+filetype+'&filename='+filename;
			  	break;
		  }		 
        });
		$("button.openshared").live("click", function() {
		  filename = this.getAttribute("id");
		  filetype = $(this).find("p").text();
		  sessionStorage.filename=filename;
		  sessionStorage.filetype=filetype;
		  if(this.getAttribute('name')==sessionStorage.loginedUserName)
		  {
			switch (filetype){
			case 'regulation':
				window.location = "index?"+'filetype='+filetype+'&filename='+filename;
			  	break;
			case 'simulation':
			  	window.location = "simulation?"+'filetype='+filetype+'&filename='+filename;
			  	break;
			case 'genecircuit':
			  	window.location = "genecircuit?"+'filetype='+filetype+'&filename='+filename;
			  	break;
			case 'plasmid':
			  	window.location = "plasmid?"+'filetype='+filetype+'&filename='+filename;
			  	break;
			case 'protocol':
			  	window.location = "protocol?"+'filetype='+filetype+'&filename='+filename;
			  	break;
		  	}		
		  }else{
		  var str=prompt("Please input the file extract code:","");
			  if(str==null||str=='')
			  {
				  return;
			  }
			  ws.send(JSON.stringify({'request': 'isExtractCodeRight', 'filename': filename,'filetype':filetype,'userName':this.getAttribute("name"),'code':str}));	
		  }
        });
		ws.onopen=function(){
			ws.send(JSON.stringify({'request': 'getLoginedUserName'}));
		};
		
        // Cleanly close websocket when unload window
        window.onbeforeunload = function() {
          ws.onclose = function () {}; // disable onclose handler first
          ws.close()
        };
      });
    </script>
  </head>
  <body>
    <div id='mymodal' style="background-color:#09F;position:absolute;top:30%;left:30%;width:30%;height:30%;display:none;">  
    <p></p> 
    <button onClick="location.reload(); ">close</button>   
    </div>
    <h1>File Manager</h1>
    <br>
    <h2>Your File List</h2>
    <table class="table table-hover">
      <thead>
        <tr>
          <th>Filename</th>
          <th>Type</th>
          <th>operation</th>
        </tr>
      </thead>
      <tbody>
        {% for item in filelist %}
        <tr id="{{ item.fileName }}">
          <th>{{ item.fileName }}</th>
          <th>{{ item.fileType }}</th>
          <th>
              <button id="{{ item.fileName }}" class="btn open">open<i class="icon-folder-open"></i><p style="display:none;">{{ item.fileType }}</p></button>
            &nbsp
            <button id="{{ item.fileName }}" class="btn delete">delete<i class="icon-trash"></i></button>
            {% if item.shared == True %}
            <button id="{{ item.fileName }}" class="btn unshared">unshared your file<i class="icon-folder-open"></i><p style="display:none;">{{ item.fileType }}</p></button>
            {% else %}
            <button id="{{ item.fileName }}" class="btn shared">shared your file<i class="icon-folder-open"></i><p style="display:none;">{{ item.fileType }}</p></button>
            {% endif %}
          </th>
        </tr>
        {% endfor %}
      </tbody>
      </table>
      <h2>Shared File List</h2>
      <table class="table table-hover">
      <thead>
        <tr>
          <th>Username</th>
          <th>Filename</th>
          <th>Type</th>
          <th>operation</th>
        </tr>
      </thead>
      <tbody>
        {% for item in sharedFileList %}
        <tr id="{{ item.fileName }}">
          <th>{{ item.name }}</th>
          <th>{{ item.fileName }}</th>
          <th>{{ item.fileType }}</th>
          <th>
              <button id="{{ item.fileName }}" class="btn openshared" name="{{ item.name }}">open shared file<i class="icon-folder-open"></i><p style="display:none;">{{ item.fileType }}</p></button>
            &nbsp
            <!--<button id="{{ item.fileName }}" class="btn delete">delete<i class="icon-trash"></i></button>-->
          </th>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <div id='tocopy' style="display:none"></div>
  </body>
</html>
